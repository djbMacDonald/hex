"use strict";var hexTemplate="&#x2B22;",hexClassTemplate="hex {{#offset}} offset {{/offset}}",menuTemplate='rows: <input type="number" value ="{{height}}" class="js-height"> columns: <input type="number" value ="{{width}}" class="js-width">',modeClassTemplate="modes {{#hidden}} hidden {{/hidden}} mode-{{name}} {{#active}} active {{/active}}",subClassTemplate="subItem {{#hidden}} hidden {{/hidden}}{{name}} js-{{name}} {{#checked}} active {{/checked}}",SubItemModel=Backbone.Model.extend({initialize:function(e){this.set({name:e}),this.set({hidden:!0})}}),ModeModel=Backbone.Model.extend({initialize:function(e){this.set({name:e.name}),this.set({url:e.url}),this.set({subItems:e.subItems})}}),HexModel=Backbone.Model.extend({initialize:function(e){this.set({x:e[0]}),this.set({y:e[1]}),this.set({trueX:this.get("x")-Math.trunc(this.get("y")/2)}),this.set({offset:this.get("y")%2})}}),BoardModel=Backbone.Model.extend({initialize:function(){this.set({width:4}),this.set({height:6}),this.set({modes:[{name:"troops",subItems:["axe","book","bow","doctor","knight","pistol","shoe","shotgun","shovel","sword","back"]},{name:"walls",subItems:["solid","weak","low","door","window","open","back"]},{name:"object",subItems:["barrier","bio","bomb","crowd","fire","rads","rock","skull","lightning","table","back"]},{name:"rotate",subItems:[]},{name:"move",subItems:[]},{name:"remove",subItems:[]}]})}}),SubItemCollection=Backbone.Collection.extend({model:SubItemModel}),ModeCollection=Backbone.Collection.extend({model:ModeModel}),GridCollection=Backbone.Collection.extend({model:HexModel}),SubItemView=Backbone.View.extend({events:{click:"select"},initialize:function(){_.bindAll(this,"render","select"),this.model.bind("change",this.render)},render:function(){var e=$("<div>"),t=Mustache.render(subClassTemplate,this.model.attributes);return this.$el.html(e).attr("class",t),this},select:function(){_(this.model.collection.models).each(function(e){e.set({checked:!1})}),this.model.set({checked:!0}),this.$el.hasClass("js-back")&&this.goBack()},goBack:function(){this.model.set("checked",!1),_(this.model.collection.models).each(function(e){e.set("hidden",!0)}),_(this.options.parent.parent.modes.models).each(function(e){e.set("hidden",!1)})}}),ModeView=Backbone.View.extend({events:{click:"check"},initialize:function(e){_.bindAll(this,"render","check"),this.parent=e.parent,this.model.bind("change",this.render);var t=this;this.subs=new SubItemCollection,_(this.model.get("subItems")).each(function(e){var s=new SubItemModel(e);t.subs.add(s)}),_(this.subs.models).each(function(e){var s=new SubItemView({model:e,parent:t});$(".js-subs").append(s.render().el)})},render:function(){var e=$("<div>"),t=Mustache.render(modeClassTemplate,this.model.attributes);return this.$el.html(e).attr("Class",t),this},check:function(){_(this.model.collection.models).each(function(e){e.set("active",!1)}),this.model.set("active",!0),$(".piece").draggable(),$(".piece").draggable("destroy"),"move"===this.model.get("name")?$(".piece").draggable():"rotate"!==this.model.get("name")&&"remove"!==this.model.get("name")&&(_(this.parent.children).each(function(e){e.model.set({hidden:!0}),e.unRenderSub()}),this.renderSub())},renderSub:function(){_(this.subs.models).each(function(e){e.set({hidden:!1})})},unRenderSub:function(){_(this.subs.models).each(function(e){e.set({hidden:!0})})}}),HexView=Backbone.View.extend({events:{click:"modify"},initialize:function(){_.bindAll(this,"render","modify"),this.model.bind("change",this.render)},render:function(){var e=Mustache.render(hexTemplate,this.model.attributes),t=Mustache.render(hexClassTemplate,this.model.attributes);return this.$el.html(e).addClass(t),this},modify:function(){this.model.set({clicked:!this.model.get("clicked")});var e;_(this.options.parent.children).each(function(t){_(t.subs.models).each(function(t){t.get("checked")&&(e=t.get("name"))})}),this.model.set("piece",e)}}),BoardView=Backbone.View.extend({el:$(".js-board"),events:{"change .js-height":"changeHeight","change .js-width":"changeWidth","click .js-grid":"addPiece"},initialize:function(){_.bindAll(this,"render","addHex","appendHex");var e=this;this.model=new BoardModel,this.model.bind("change",this.render),this.grid=new GridCollection,this.modes=new ModeCollection,_(this.model.get("modes")).each(function(t){var s=new ModeModel(t);e.modes.add(s)}),this.render()},render:function(){$(".js-modes").empty();var e=this;e.children=[],e.buildGrid();var t=Mustache.render(menuTemplate,this.model.attributes);$(".js-size").html(t),$(".js-grid").empty(),_(this.grid.models).each(function(t){e.appendHex(t)},this),_(this.modes.models).each(function(t){var s=new ModeView({model:t,parent:e});$(".js-modes",e.el).append(s.render().el),e.children.push(s)})},buildGrid:function(){this.grid.reset();for(var e=0;e<this.model.get("height");e++)for(var t=0;t<this.model.get("width");t++)this.addHex(t,e)},changeHeight:function(){this.model.set("height",$(".js-height").val())},changeWidth:function(){var e=$(".js-width").val();this.model.set("width",parseInt(e))},addHex:function(e,t){var s=new HexModel([e,t]);this.grid.add(s)},appendHex:function(e){var t=new HexView({model:e,parent:this});$(".js-grid",this.el).append(t.render().el),e.get("x")+1===this.model.get("width")&&$(".js-grid",this.el).append("<br>")},addPiece:function(e){var t,s;if(_(this.children).each(function(e){e.model.get("active")&&(t=e.model.get("name")),_(e.subs.models).each(function(e){e.get("checked")&&(s=e.get("name"))})}),s&&"rotate"!==t&&"move"!==t&&"remove"!==t&&"back"!==s){var i=$("<div>");i.addClass("piece"),i.addClass(t),i.addClass(s),"walls"===t?i.addClass("r"):i.addClass("ur"),"walls"===t?i.css({left:e.pageX-10,top:e.pageY-40}):i.css({left:e.pageX-40,top:e.pageY-40}),$("body").append(i);var d=this;i.click(function(){d.modify($(this))})}},modify:function(e){var t;_(this.children).each(function(e){e.model.get("active")&&(t=e.model.get("name"))}),"remove"===t?e.remove():"rotate"===t&&(e.hasClass("ur")?(e.removeClass("ur"),e.addClass("r")):e.hasClass("r")?(e.removeClass("r"),e.addClass("lr")):e.hasClass("lr")?(e.removeClass("lr"),e.addClass("ll")):e.hasClass("ll")?(e.removeClass("ll"),e.addClass("l")):e.hasClass("l")?(e.removeClass("l"),e.addClass("ul")):e.hasClass("ul")&&(e.removeClass("ul"),e.addClass("ur")))}});$(document).ready(function(){new BoardView});